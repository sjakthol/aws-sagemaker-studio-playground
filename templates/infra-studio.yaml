---
AWSTemplateFormatVersion: 2010-09-09
Description: Amazon Sagemaker Studio - Infra resources for SageMaker Studio

Parameters:
  DeploymentName:
    Description: A prefix for the stacks in this setup.
    Type: String

Resources:
  WorkspaceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-workspace'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DefaultRules
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            NoncurrentVersionExpirationInDays: 7
      LoggingConfiguration:
        DestinationBucketName: !ImportValue infra-buckets-LogBucket
        LogFilePrefix: !Sub s3_access/bucket=${AWS::StackName}/
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - { Key: 'Name', Value: !Sub '${AWS::StackName}-workspace' }

  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - sagemaker.amazonaws.com
                - glue.amazonaws.com
            Action:
             - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Path: /service-role/
      Policies:
      - PolicyName: EMRAccess
        PolicyDocument:
          Version: 2012-10-17
          Statement:
            - Sid: AllowClusterDiscovery
              Effect: Allow
              Action:
                - elasticmapreduce:ListClusters
              Resource: '*'
            - Sid: AllowClusterDetailsAccess
              Effect: Allow
              Action:
                - elasticmapreduce:CreatePersistentAppUI
                - elasticmapreduce:DescribeCluster
                - elasticmapreduce:DescribePersistentAppUI
                - elasticmapreduce:DescribeSecurityConfiguration
                - elasticmapreduce:GetOnClusterAppUIPresignedURL
                - elasticmapreduce:GetPersistentAppUIPresignedURL
                - elasticmapreduce:ListInstanceGroups
                - elasticmapreduce:ListInstances
              Resource:
                - !Sub arn:aws:elasticmapreduce:${AWS::Region}:${AWS::AccountId}:cluster/*
              Condition:
                StringEquals:
                  aws:ResourceTag/DeploymentName: !Ref DeploymentName
            - Sid: AllowSagemakerProjectManagement
              Effect: Allow
              Action:
                - sagemaker:CreateProject
                - sagemaker:DeleteProject
              Resource:
                - !Sub arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:project/*
            - Sid: AllowEMRTemplateDiscovery
              Effect: Allow
              Action:
                - servicecatalog:SearchProducts
              Resource: '*'

  ExecutionRoleGlueSessionAccess:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: GlueSessionAccess
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - glue:ListSessions
            Resource: '*'
          - Effect: Allow
            Action:
              - glue:CreateSession
            Resource:
              - arn:aws:glue:*:*:session/*
            Condition:
              StringEquals:
                aws:RequestTag/owner: ${aws:userid}
              ForAnyValue:StringEquals:
                aws:TagKeys:
                  - owner
          - Effect: Allow
            Action:
              - glue:RunStatement
              - glue:GetStatement
              - glue:ListStatements
              - glue:CancelStatement
              - glue:StopSession
              - glue:DeleteSession
              - glue:GetSession
            Resource:
              - arn:aws:glue:*:*:session/*
            Condition:
              StringEquals:
                aws:ResourceTag/owner: ${aws:userid}
          - Effect: Deny
            Action:
              - glue:TagResource
              - glue:UntagResource
              - tag:TagResources
              - tag:UntagResources
            Resource:
              - arn:aws:glue:*:*:session/*
            Condition:
              ForAnyValue:StringEquals:
                aws:TagKeys: owner
          - Effect: Allow
            Action: iam:PassRole
            Resource: !GetAtt ExecutionRole.Arn
            Condition:
              StringEquals:
                iam:PassedToService:
                  - glue.amazonaws.com
          - {
                "Effect": "Allow",
                "Action": "glue:*",
                "Resource": [
                    "arn:aws:glue:*:*:catalog/*",
                    "arn:aws:glue:*:*:database/*",
                    "arn:aws:glue:*:*:table/*",
                    "arn:aws:glue:*:*:tableVersion/*",
                    "arn:aws:glue:*:*:connection/*",
                    "arn:aws:glue:*:*:userDefinedFunction/*",
                    "arn:aws:glue:*:*:devEndpoint/*",
                    "arn:aws:glue:*:*:job/*",
                    "arn:aws:glue:*:*:trigger/*",
                    "arn:aws:glue:*:*:crawler/*",
                    "arn:aws:glue:*:*:workflow/*",
                    "arn:aws:glue:*:*:mlTransform/*",
                    "arn:aws:glue:*:*:registry/*",
                    "arn:aws:glue:*:*:schema/*"
                ]
            }
          - {
                "Effect": "Allow",
                "Action": [
                    "s3:CreateBucket"
                ],
                "Resource": [
                    "arn:aws:s3:::aws-glue-*"
                ]
            }
          - {
                "Effect": "Allow",
                "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:DeleteObject"
                ],
                "Resource": [
                    "arn:aws:s3:::aws-glue-*/*",
                    "arn:aws:s3:::*/*aws-glue-*/*"
                ]
            }
          - {
                "Effect": "Allow",
                "Action": [
                    "s3:GetObject"
                ],
                "Resource": [
                    "arn:aws:s3:::crawler-public*"
                ]
            }
          - {
                "Effect": "Allow",
                "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                ],
                "Resource": [
                    "arn:aws:logs:*:*:/aws-glue/*"
                ]
            }
          - {
                "Effect": "Allow",
                "Action": [
                    "ec2:CreateTags",
                    "ec2:DeleteTags"
                ],
                "Condition": {
                    "ForAllValues:StringEquals": {
                        "aws:TagKeys": [
                            "aws-glue-service-resource"
                        ]
                    }
                },
                "Resource": [
                    "arn:aws:ec2:*:*:network-interface/*",
                    "arn:aws:ec2:*:*:security-group/*",
                    "arn:aws:ec2:*:*:instance/*"
                ]
            }
      Roles:
        - !Ref ExecutionRole

  ExecutionRoleExtraPermissions:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: ExtraAccess
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: iam:GetRole
            Resource: !GetAtt ExecutionRole.Arn
      Roles:
        - !Ref ExecutionRole

  StudioSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${AWS::StackName}-sg
      GroupDescription: !Sub Security Group for SageMaker Studio ENIs of ${DeploymentName}
      Tags:
        - { Key: Name, Value: !Sub '${AWS::StackName}-sg' }
      VpcId: !ImportValue infra-vpc-VpcId

  StudioSecurityGroupSelfRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref StudioSecurityGroup
      IpProtocol: tcp
      FromPort: 8192
      ToPort: 65535
      SourceSecurityGroupId: !Ref StudioSecurityGroup

  ## Service Catalog Roles ##

  ServiceCatalogRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: servicecatalog.amazonaws.com
            Action: sts:AssumeRole
      Description: Role AWS Service Catalog uses to launch and terminate EMR clusters.
      RoleName: !Sub ${AWS::StackName}-ServiceCatalogRole
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-ServiceCatalogRolePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource: "*" # trust Service Catalog to do the right thing
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStackEvents
                  - cloudformation:DescribeStacks
                  - cloudformation:GetTemplateSummary
                  - cloudformation:SetStackPolicy
                  - cloudformation:UpdateStack
                  - cloudformation:ValidateTemplate
                  - elasticmapreduce:DescribeCluster
                  - elasticmapreduce:ListInstanceFleets
                  - elasticmapreduce:RunJobFlow
                  - elasticmapreduce:TerminateJobFlows
              - Effect: Allow
                Action:
                  - "iam:PassRole"
                Resource:
                  - Fn::ImportValue: !Sub ${DeploymentName}-infra-emr-EmrInstanceRole
                  - Fn::ImportValue: !Sub ${DeploymentName}-infra-emr-EmrServiceRole
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: "*"
                Condition:
                  StringEquals:
                    s3:ExistingObjectTag/servicecatalog:provisioning: true

Outputs:
  StudioSecurityGroup:
    Description: Security Group for SageMaker Studio ENIs
    Value: !GetAtt StudioSecurityGroup.GroupId
    Export:
      Name: !Sub "${AWS::StackName}-StudioSecurityGroup"

  ExecutionRoleArn:
    Description: The ARN of the IAM role to use as SageMaker Studio execution role
    Value: !GetAtt ExecutionRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ExecutionRoleArn"

  ServiceCatalogRoleArn:
    Description: The ARN of the IAM role for Service Catalog to launch EMR clusters with
    Value: !GetAtt ServiceCatalogRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ServiceCatalogRoleArn"
